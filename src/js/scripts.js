let store = {
    reviews: [
        {
            id: 0,
            productName: 'Дрель ударная BOSCH PSB 550 RЕ, БЗП Арт.0603130020',
            productPhoto: './img/productImgs/drill.png',
            reviewText: "Значит купил я данную модель, поработал неделю, отказал один аккумулятор, заряд держиттак себе, НООООООООО МАГАЗИН АДЕКВАТНЫЙ, ОБМЕНЯЛИ НА НОВЫЙ, ПРИЧЁМ ПРИВЕЗЛИ ДОМОЙ.С ТАКИМ ПРОДАВЦОМ ПРИЯТНО ИМЕТЬ ДЕЛО!!!",
            impression: 0,
            conformity: 0,
            reliability: 0,
            date: "1 августа, 2018",
            postStatus: "posted",
            photos: [],
            modifiedStatus: true,
            modifiedDate: ' 19 августа, 2018',
            modifiedText: 'год прошёл, работает как пушка!',
            modifiedPhotos: ['./img/messageImgs/workingDrill.png', './img/messageImgs/drill.png',],
            modifiedPostStatus: 'moderating',
        },
        {
            id: 0,
            productName: 'Дрель ударная BOSCH PSB 550 RЕ, БЗП Арт.0603130020',
            productPhoto: './img/productImgs/drill.png',
            reviewText: 'Идёт мужик по полю, видит подкова. Думает: "Возьму её себе домой, над дверью повешy - она мне удачу принесёт". Приносит он её домой, переворачивает - а там конь.',
            impression: 3,
            conformity: 1,
            reliability: 3,
            date: "1 августа, 2018",
            postStatus: "posted",
            photos: [],
            modifiedStatus: false,
            modifiedDate: ' 19 августа, 2018',
            modifiedText: 'Кузнец держит щипцами раскалённую подкову. — Боже, какая она горячая! — восхищается крестьянин. — Да ладно! — говорит кузнец. — Дадите десятку, так я её языком оближу. В предвкушении необычного зрелища крестьянин протянул кузнецу денежку. Кузнец облизал десятку и положил в карман.',
            modifiedPhotos: [],
            modifiedPostStatus: 'posted',
        },
        {
            id: 0,
            productName: 'Дрель ударная BOSCH PSB 550 RЕ, БЗП Арт.0603130020',
            productPhoto: './img/productImgs/drill.png',
            reviewText: "Врач сказал: «Джо, хорошая новость – это то, что я могу избавить тебя от твоих головных болей. Плохая новость – это то, что для этого потребуется кастрация. У тебя очень редкое состояние, из-за которого твои тестикулы давят на нижний отдел позвоночника, и это давление вызывает у тебя жуткую головную боль. Единственный способ снизить это давление – их удаление». Джо был в отчаянии. Ему даже жить расхотелось. Но выбора не было, и он согласился пойти под нож. Когда он вышел из больницы, впервые за 20 лет его не терзала головная боль, но его не покидало сожаление об утраченной части самого себя. Но потом он решил, что нужно начать новую жизнь. Он увидел магазин мужской одежды и подумал: «А не купить ли мне новый костюм?» Он вошёл в магазин и сказал продавцу: «Мне нужен костюм». Пожилой продавец смерил его быстрым взглядом и сказал: «Так… Рост 44». Джо рассмеялся: «Верно, откуда вы знаете?» - «60 лет в бизнесе». Джо примерил костюм,- он был впору. Пока Джо любовался собой в зеркале, продавец спросил: «Как насчёт новой рубашки?» Джо подумал и согласился. Продавец взглянул на Джо и сказал: «Так. 34 рукав и 16 с половиной шея». И вновь Джо удивился. «Верно, откуда вы знаете?» - «60 лет в бизнесе». Джо примерил рубашку, и она сидела великолепно. Когда Джо поправлял перед зеркалом воротничок, продавец спросил: «Может быть, вам нужны новые ботинки?» Джо понравилась эта мысль. Продавец взглянул на Джо и сказал: «Так… 9-1/2 E». Джо был потрясён. «Верно, откуда вы знаете?» - «60 лет в бизнесе». Джо примерил ботинки, и они ему подошли. Джо прошёлся по магазину, и продавец спросил: «А нижнее бельё?» Джо подумал и согласился. Продавец сделал шаг назад, смерил взглядом талию Джо и сказал: «Так… Размер 36». Джо расхохотался. «Ха-ха! Вот я вас и поймал! Я с восемнадцати лет ношу 34-й!» Продавец покачал головой: «Вы не можете носить 34-й. 34-й размер нижнего белья придавит ваши тестикулы к нижнему отдела позвоночника, и у вас будет жуткая головная боль».",
            impression: 1,
            conformity: 3,
            reliability: 1,
            date: "1 августа, 2018",
            postStatus: "moderating",
            photos: ['./img/messageImgs/workingDrill.png', './img/messageImgs/drill.png',],
            modifiedStatus: false,
            modifiedDate: ' 19 августа, 2018',
            modifiedText: 'В части ожидается приезд генерала. Всё кругом чистят-красят. Одного солдата послали покрасить ракету. Он почти всю покрасил, но до самой макушки не достаёт. Думает: как же быть? Придумал! Берёт ведро краски, размахивается и забрасывает его на макушку ракеты. Ура! Ракета вся покрашена. Но ведро осталось висеть на носу ракеты. Генерал обходит часть: так, хорошо, трава зелёная, забор тоже покрашен. - А это что за хрень на ракете? - спрашивает у командира части. - Это миноотражатель, товарищ генерал! - не растерялся командир. - Сам вижу что миноотражатель! Почему не покрашен?!',
            modifiedPhotos: [],
            modifiedPostStatus: 'posted',
        },
        {
            id: 0,
            productName: 'Декоративный металлический экран на радиатор 3-х секционный 3 ДМЭР',
            productPhoto: './img/productImgs/dryer.png',
            reviewText: "Отслужив срочную службу в армии, солдат вернулся в родную деревушку. Все, естественно, обступили его и давай вопросами засыпать: что там, где там, как там. Солдат и рассказывает: - Армия - это дебилизм! - Это почему же? - удивились жители деревни. - Завтра узнаете. В четыре часа утра в деревне раздался колокольный звон. Все сельчане сбежались. Стоят в исподнем, сонные, ругаются. Выходит солдат и говорит: - Значит так: мы с батей - за дровами, остальные - разойтись!",
            impression: 5,
            conformity: 5,
            reliability: 5,
            date: "1 августа, 2018",
            postStatus: "notposted",
            photos: ['./img/messageImgs/workingDrill.png', './img/messageImgs/drill.png',],
            modifiedStatus: false,
            modifiedDate: ' 19 августа, 2018',
            modifiedText: 'На занятиях по артиллерийской стрельбе: — Пушка стреляет, и снаряд летит по параболе… — Товарищ майор, а если пушку на бок положить, то и за угол стрелять можно будет?— Можно, но по Уставу не положено',
            modifiedPhotos: [],
            modifiedPostStatus: 'posted',
        },
    ],
    getReviews() {
        return this.reviews
    },
}

const component = {
    state: {
        productName: '',
        productPhot: '',
        reviewText: '',
        date: '',
        postStatus: '',
        photos: '',
        impression: '',
        conformity: '',
        reliability: '',
        templateIndex: '',
        modifiedStatus: '',
        modifiedDate: '',
        modifiedText: '',
        modifiedPhotos: '',
        modifiedPostStatus: '',
        modifiedTemplateIndex: null
    },

    setState(reviews, index) {
        let {
            productName,
            productPhoto,
            reviewText,
            date,
            postStatus,
            photos,
            impression,
            conformity,
            reliability,
            modifiedStatus,
            modifiedDate,
            modifiedText,
            modifiedPhotos,
            modifiedPostStatus,
        } = reviews
        this.state.productName = productName
        this.state.productPhoto = productPhoto
        this.state.reviewText = reviewText
        this.state.date = date
        this.state.postStatus = postStatus
        this.state.photos = photos
        this.state.templateIndex = index
        this.state.impression = impression
        this.state.conformity = conformity
        this.state.reliability = reliability
        this.state.modifiedStatus = modifiedStatus
        this.state.modifiedDate = modifiedDate
        this.state.modifiedText = modifiedText
        this.state.modifiedPhotos = modifiedPhotos
        this.state.modifiedPostStatus = modifiedPostStatus
        this.state.modifiedTemplateIndex = index + 'm'
    },

    reviewBlockInit(reviews, templateIndex) {
        this.setState(reviews, templateIndex)
        if (this.state.modifiedStatus) {
            modifiedTableWrapClass = 'table-item__wrap--modified'
            modifiedBlock = 'modifiedBlock'
        }

        return `    <div class="table-item">
                    <div class="table-item__wrap ${modifiedTableWrapClass}">
                        <img class="product-photo" src="${this.state.productPhoto}"alt="фото товара">
                        <span class="product-name">${this.state.productName}</span>
                        <div class="review__wrap">
                            ${this.scoreBlockInit(this.state.postStatus, this.state.impression, this.state.conformity, this.state.reliability)}
                            <div class="review__body ${this.reviewBodyClassInit(this.state.postStatus)} ">
                                <h3 class="review__title ${this.textTitleClassInit(this.state.postStatus)}">${this.textTitleValueInit(this.state.postStatus)}</h3>
                                ${this.textBlockInit(this.state.reviewText, this.state.templateIndex)}
                                <div class="review__imgs">
                                    ${this.photosInit(this.state.photos)}
                                </div>
                            </div>
                        </div>
                        <div class="review-state">
                            <span class="review-state__status ${this.statusClassInit(this.state.postStatus)}">${this.statusValueInit(this.state.postStatus)}</span>
                            <span class="review-state__date">${this.state.date}</span>
                        </div>
                        ${this.actionBlockInit(this.state.postStatus)}
                        ${this.modifiedBlockInit(this.state.modifiedStatus, this.state.postStatus)}
                    </div>
                </div>`
    },

    modifiedBlockInit(modifiedStatus, postStatus) {
        if (modifiedStatus === true && postStatus !== 'notposted') {
            return `    <div class="review__wrap--modified">
                            <h3 class="review__title review__title--mobile-width${this.textTitleClassInit(this.state.modifiedPostStatus)}">${this.textTitleValueInit(this.state.modifiedPostStatus, modifiedStatus)}</h3>
                            <div class="review__body review__body--modified ${this.reviewBodyClassInit(this.state.modifiedPostStatus)}">
                                <h3 class="review__title review__title--modified ${this.textTitleClassInit(this.state.modifiedPostStatus)}">${this.textTitleValueInit(this.state.modifiedPostStatus, modifiedStatus)}</h3>
                                ${this.textBlockInit(this.state.modifiedText, this.state.modifiedTemplateIndex, true)}
                                <div class="review__imgs">
                                ${this.photosInit(this.state.modifiedPhotos)}
                                </div>
                            </div>
                            <div class="review-state review-state--modified">
                                <span class="review-state__status ${this.statusClassInit(this.state.modifiedPostStatus)}">${this.statusValueInit(this.state.modifiedPostStatus)}</span>
                                <span class="review-state__date">${this.state.modifiedDate}</span>
                            </div>
                        </div>`
        }
        return ''

    },
    photosInit(photoArray) {
        let photos = ''
        photoArray.map(photo => {
            photos += `<a href="#" data-src="${photo}" class="review__img-wrap">
                            <img class="review__img" src="${photo}" alt="img">
                        </a>`
        })
        return photos
    },
    statusClassInit(postStatus) {
        switch (postStatus) {
            case 'moderating': return 'review-state__status--moderating'
            case 'posted': return 'review-state__status--posted'
            case 'notposted': return 'review-state__status--notposted'
            default: return ''
        }
    },
    statusValueInit(postStatus) {
        switch (postStatus) {
            case 'moderating': return 'на модерации'
            case 'posted': return 'опубликован'
            case 'notposted': return 'не опубликован'
            default: return ''
        }
    },
    actionBlockInit(postStatus) {
        if (postStatus === 'notposted') {
            return ''
        }
        if (postStatus === 'posted' || 'moderating') {
            return `<div class="review-action">
                        <span class="review-action__button">Дополнить отзыв</span>
                    </div>`
        }

    },
    textTitleClassInit(postStatus) {
        if (postStatus === 'notposted') {
            return `review__title--notposted`
        }
        return ''
    },
    textTitleValueInit(postStatus, modifiedStatus) {
        if (postStatus === 'notposted') {
            return 'К сожалению, ваш отзыв не прошёл модерацию.'
        }
        if (postStatus === 'posted' || 'moderating') {
            if (modifiedStatus) {
                return 'Дополненный отзыв'
            }
            return 'Отзыв'
        }

    },
    reviewBodyClassInit(postStatus) {
        if (postStatus === 'notposted') {
            return 'review__body--notposted'
        }
        return ''
    },
    scoreBlockInit(postStatus, impression, conformity, reliability) {
        let score = +((impression + conformity + reliability) / 3).toFixed(1)
        let scoreValue = +((impression + conformity + reliability) / 3).toFixed(1)

        if ((score ^ 0) === score) {
            score = score + '.0'
        } else { score = +score.toFixed(1) }

        let starsFillInit = (score) => {
            let intPart = Math.floor(score),
                floatPart = Math.round((score - intPart) * 10),
                starsBlock = ''
            for (let i = 0; i < 5; i++) {
                if (intPart > i) {
                    starsBlock += `<img src="./img/common/rating_star100.svg" alt="star">`
                }
                if (intPart === i) {
                    if (floatPart === 0) starsBlock += `<img src="./img/common/rating_star0.svg" alt="star">`
                    if (0 < floatPart && floatPart <= 3) starsBlock += `<img src="./img/common/rating_star025.svg" alt="star">`
                    if (4 <= floatPart && floatPart <= 6) starsBlock += `<img src="./img/common/rating_star050.svg" alt="star">`
                    if (7 <= floatPart && floatPart <= 9) starsBlock += `<img src="./img/common/rating_star075.svg" alt="star">`
                }
                if (intPart < i) {
                    for (let j = i + 1; j <= 5; j++) {
                        starsBlock += `<img src="./img/common/rating_star0.svg" alt="star">`
                    }
                    break
                }
            }
            return starsBlock
        }
        if (postStatus !== 'notposted') {
            return `<div class="review__score">
                        <div class="review__rating">
                            ${starsFillInit(scoreValue)}
                            <span>${score}</span>
                        </div>
                        <span class="review__impression">Впечатление: ${impression}</span>
                            <span class="review__conformity">Соответствие: ${conformity}</span>
                        <span class="review__reliability">Надежность: ${reliability}</span>
                    </div>`
        }
        return ''
    },

    textBlockInit(text, templateIndex) {
        let collapsedText = text.slice(0, 195).trim()
        if (text.length > 195) {
            return `
                    <div class="review__text" id="review__text--${templateIndex}"><p>${collapsedText}...</p><p>${text}</p></div>
                    <div class="review__collapse-button" >
                        <span id="collapse-button--${templateIndex}">подробнее</span>
                        <img class="arrow" id="arrow--${templateIndex}" src="./img/common/arrow.svg" alt="arrow">
                    </div>`
        }
        return `<div class="review__text" id="review__text--${templateIndex}"><p>${text}</p></div>`
    },
}

$(function () {
    let templateIndex = []
    let scrollPosition = null
    $('.table-body').html(
        store.getReviews().map((reviews, index) => {
            templateIndex.push(index)
            return component.reviewBlockInit(reviews, index)
        })
    )

    templateIndex.map(index => {
        $(`#collapse-button--${index}, #arrow--${index}`).click((e) => {
            $(`#review__text--${index}`).toggleClass('review__text--full')
            $(`#arrow--${index}`).toggleClass('arrow--active')
        })

        $(`#collapse-button--${index}m, #arrow--${index}m`).click(() => {
            $(`#review__text--${index}m`).toggleClass('review__text--full')
            $(`#arrow--${index}m`).toggleClass('arrow--active')
        })
    })

    $(`.review__img-wrap`).click((e) => {
        $('.modal__photo').attr({ "src": `${e.currentTarget.dataset.src}` })
        $('.modal').toggleClass('modal--show')
        $('body').css({ "overflow": "hidden" })
        scrollPosition = $(window).scrollTop();
    })

    $('.close-button').click(() => {
        $('.modal').removeClass('modal--show')
        $('body').css({ "overflow": "visible" })
        $(window).scrollTop(scrollPosition)
    })

})






